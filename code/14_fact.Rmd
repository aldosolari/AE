---
title: "Analisi Fattoriale"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
```

## Dati Esami

1. Si consideri la seguente matrice di correlazione

```{r, echo=FALSE}
R = matrix(c(
 1.000, 0.439, 0.410, 0.288, 0.329, 0.248,
 0.439, 1.000, 0.351, 0.354, 0.320, 0.329,
 0.410, 0.351, 1.000, 0.164, 0.190, 0.181,
 0.288, 0.354, 0.164, 1.000, 0.595, 0.470,
 0.329, 0.320, 0.190, 0.595, 1.000, 0.464,
 0.248, 0.329, 0.181, 0.470, 0.464, 1.000
), byrow=T, ncol=6)
colnames(R) = c("Gaelic", "English", "History", "Arithmetic", "Algebra", "Geometry")
R
```

relativa ai voti di $n=220$ studenti maschi nelle materie *Gaelic*, *English*, *History*, *Arithmetic*, *Algebra* e *Geometry* ($p=6$). Interpretare la matrice di correlazione. 

I voti tra le materie sono correlati positivamente, ovvero gli studenti che vanno bene in una specifica materia vanno bene anche nelle altre. Le correlazioni più forti si trovano nel gruppo delle materie matematiche, e in misura leggermente inferiore, nel gruppo delle
materie umanistiche, mentre c'è meno correlazione tra i due gruppi di materie.  

2. Stimare con il metodo della massima verosimiglianza il modello fattoriale con $k=2$ fattori (funzione `factanal()`, argomenti `factors=2` e  `rotation="none"`), ottenendo
*  la stima della matrice dei pesi fattoriali, interpretando i due fattori ottenuti;
*  la stima delle comunalità e delle varianze specifiche, interpretando la bontà del modello;
* la differenza tra $R$ e  $\hat{\Lambda} \hat{\Lambda}' + \hat{\Psi}$.


```{r}
n = 220
# modello fattoriale con 2 fattori senza rotazione
af <- factanal(covmat=R, factors=2, rotation="none", n.obs=n)   
af

# stima dei pesi fattoriali
Lambda <- af$loadings[,]
round(Lambda,3)

# primo fattore "andare bene a scuola"
# secondo fattore "math vs non-math"

# stima delle comunalità
h2 <- apply(af$loadings^2,1,sum)
round(h2,3)

# stima delle varianze specifiche
Psi <- diag(af$uniquenesses)
round(diag(Psi),3)

# differenza
fit = Lambda%*%t(Lambda) + Psi
round( R - fit, 4)
```

3. Stimare il modello fattoriale con $k=2$ fattori eseguendo la rotazione `varimax` della matrice dei pesi fattoriali (argomento `rotation="varimax"`).
Confrontare le stime delle varianze specifiche e della matrice dei pesi fattoriali con la soluzione senza rotazione. 


```{r}
# rotazione varimax
af2 <- factanal(covmat = R, factors=2, rotation="varimax", n.obs=n) # default

# le varianze specifiche non cambiano
round(af2$uniquenesses,3)

# matrice di rotazione
af2$rotmat


# la matrice dei pesi fattoriali cambia
af2$loadings

# primo fattore "math"
# secondo fattore "non-math"

# rappresentazione grafica della rotazione
plot(af$loadings,xlim=c(-1,1), ylim=c(-1,1), pch="", asp=1)
text(af$loadings, colnames(R))
abline(h=0)
abline(v=0)
af2 <- varimax(af$loadings,normalize=FALSE)
abline(0, af2$rotmat[2,1]/af2$rotmat[1,1], lty=2)
abline(0, af2$rotmat[2,2]/af2$rotmat[1,2], lty=2)
```


3. Stimare il modello fattoriale con $k=2$ con il metodo dei fattori principali:

* Calcolare la stima iniziale delle comunalità $\hat{h}^2_i$ come 
$$\hat{h}^2_i = 1 - 1/r^{ii}$$, dove $r^{ii}$ è l'elemento di posizione $(i,i)$ della matrice $R^{-1}$
* Ottenere la matrice di correlazione ridotta $$R^*= R - \hat{\Psi}$$ dove $\hat{\Psi} = diag(\hat{\psi}_1,\ldots,\hat{\psi}_p)$ con $\hat{\psi}_i = 1 - \hat{h}^2_i$
* Calcolare la stima della matrice dei pesi fattoriali $$\hat{\Lambda} = V_k L^{1/2}_k$$ 
dopo aver ottenuto la decomposizione spettrale di $R^* = V L V'$ e dove
$\underset{p \times k}{V_k}$ contiene le prime $k$ colonne di $V$ e $\underset{k \times k}{L_k} = diag(l_1,\ldots,l_k)$ le prime $k$ colonne di $L$. 
* calcolare la differenza tra $R$ e  $\hat{\Lambda} \hat{\Lambda}' + \hat{\Psi}$ e confrontarla con quanto ottenuto dalla stima di massima verosimiglianza.


```{r}
# calcolare R^-1
invR =  solve(R)

# stima iniziale delle comunalità 
h2<-1-1/(diag(solve(R)))
round(h2,3)
# stima di Psi
Psi = diag(1-h2)

# matrice di correlazione ridotta
Rstar = R - Psi

# stima della matrice dei pesi fattoriali
eigen = eigen(Rstar)
k = 2
Lambda <- eigen$vectors[,1:k] %*% diag(eigen$values[1:k]^{1/2})
Lambda

# aggiorno stima delle comunalità 
h2 = apply(Lambda^2,1,sum)
Psi = diag(1-h2)

# differenza
fit = Lambda%*%t(Lambda) + Psi
round( R - fit, 4)
```


4. Si riporti il $p$-value del test rapporto di verosimiglianza per verificare l'ipotesi nulla $H_0:$ `$k=1$ fattore è sufficiente', e si concluda ad un livello di significatività del $5\%$ se è opportuno utilizzare il modello fattoriale ad 1 fattore. 

```{r, echo=T}
factanal(covmat=R, factors=1, n.obs = n)$PVAL
```

\newpage

## Dati Open/Closed Book Examination Data

1. Caricare il dati `scor` presenti nella libreria `bootstrap` e calcolare la matrice di correlazione $\underset{p\times p}{R}$. 

```{r}
library(bootstrap)

# carico i dati:
data(scor)
X <- scor
n <- nrow(X)
p <- ncol(X)

# matrice di correlazione
R <- cor(X)
round(R, 2)
```

### Metodo dei fattori principali

2. Calcolare la stima iniziale delle comunalità $\hat{h}^2_i$ come 
$$\hat{h}^2_i = \max_{j\neq i}|r_{ij}|$$  per $i=1,\ldots,p$, dove $r_{ij}$ è l'elemento di posizione $(i,j)$ della matrice $R$. Ottenere la matrice di correlazione ridotta $$R^*= R - \hat{\Psi}$$ dove $\hat{\Psi} = diag(\hat{\psi}_1,\ldots,\hat{\psi}_p)$ con $\hat{\psi}_i = 1 - \hat{h}^2_i$.

```{r}

# sostituisco 1 sulla diagonale di R con 0
R0 <- R - diag(rep(1,p))

# calcolo la stima iniziale della comunalità
h2 <- apply(abs(R0), 2, max)
h2 

# calcolo la stima di Psi
Psi = diag(1-h2)
Psi

# calcolo la matrice di correlazione ridotta R* 
Rstar <- R - Psi 
round(Rstar,2)

```

3. Considerando il modello fattoriale con $k=2$ fattori

* calcolare la stima della matrice dei pesi fattoriali $$\hat{\Lambda} = V_k L^{1/2}_k$$ 
dopo aver ottenuto la decomposizione spettrale di $R^* = V L V'$ e dove
$\underset{p \times k}{V_k}$ contiene le prime $k$ colonne di $V$ e $\underset{k \times k}{L_k} = diag(l_1,\ldots,l_k)$. 

* aggiornare la stima delle comunalità $$\hat{h}^2_i = \sum_{j=1}^{k} \hat{\lambda}^2_{ij}$$ dove $\hat{\lambda}_{ij}$ è
l'elemento di posizione $(i,j)$ della matrice $\hat{\Lambda}$ ottenuta al passo precedente

* aggiornare la stima della matrice di correlazione ridotta $$R^*= R - \hat{\Psi}$$ dove $\hat{\Psi} = diag(\hat{\psi}_1,\ldots,\hat{\psi}_p)$ con $\hat{\psi}_i = 1 - \hat{h}^2_i$ dove $\hat{h}^2_i$ è la stima ottenuta al passo precedente

```{r}
# decomposizione spettrale di R*
eigen <- eigen(Rstar)

#  k=2
k = 2

# stima di Lambda
Lambda <- eigen$vectors[,1:k] %*% diag(eigen$values[1:k]^{1/2})
Lambda

# nuova stima comunalità 
h2.new = apply(Lambda^2, 1, sum)
h2.new

# nuova stima di Psi
Psi.new <- diag(1-h2.new)
Psi.new

# nuova stima di R*
Rstar.new = R - Psi.new
Rstar.new

```

4. Iterare per 100 volte la procedura descritta al punto 3, ottenendo le stime finali per $\hat{\Lambda}$ e $\hat{\Psi}$. Calcolare la differenza tra $R$ e  $\hat{\Lambda} \hat{\Lambda}' + \hat{\Psi}$ e commentare. 

```{r}
for (i in 1:100){
  h2 <- apply(Lambda^2, 1, sum)
  Rstar <- R0 + diag(h2)
  eigen <- eigen(Rstar)
  Lambda <- eigen$vectors[,1:k] %*% diag(eigen$values[1:k]^{1/2})
}

# stima finale per Lambda
Lambda
# stima finale per le comunalità
h2 <- apply(Lambda^2, 1, sum)
h2
# stima finale per Psi
Psi = diag(1-h2)

# differenza
fit = Lambda%*%t(Lambda) + Psi
round( R - fit, 4)

```

### Stima di Massima Verosimiglianza

5. Utilizzando la funzione `factanal()`, stimare con il metodo della massima verosimiglianza il modello fattoriale con $k=2$ fattori (argomento `factors=2`) senza eseguire la rotazione della matrice dei pesi fattoriali (argomento `rotation="none"`). Visualizzare la stima della matrice dei pesi fattoriali, delle comunalità e delle varianze specifiche, e calcolare la differenza tra $R$ e  $\hat{\Lambda} \hat{\Lambda}' + \hat{\Psi}$.

```{r}
# modello fattoriale con 2 fattori senza rotazione
af <- factanal(X, factors=2, rotation="none")   

af

# stima dei pesi fattoriali
Lambda <- af$loadings[,]
Lambda

# stima delle comunalità
h2 <- apply(af$loadings^2,1,sum)
h2

# stima delle varianze specifiche
Psi <- diag(af$uniquenesses)
Psi

# differenza
fit = Lambda%*%t(Lambda) + Psi
round( R - fit, 4)
```

6. Stimare il modello fattoriale con $k=2$ fattori eseguendo la rotazione `varimax` della matrice dei pesi fattoriali (argomento `rotation="varimax"`).
Confrontare le stime delle varianze specifiche e della matrice dei pesi fattoriali con la soluzione senza rotazione. 

```{r}

# rotazione varimax
af2 <- factanal(X, factors=2, rotation="varimax") # default

# le varianze specifiche non cambiano
af2$uniquenesses

# la matrice dei pesi fattoriali cambia
af2$loadings

# primo fattore "being good at school"
# secondo fattore "ability in closed book vs open book exams"

# rappresentazione grafica della rotazione
plot(af$loadings,xlim=c(-1,1), ylim=c(-1,1), pch="", asp=1)
text(af$loadings, names(X))
abline(h=0)
abline(v=0)

af2 <- varimax(af$loadings,normalize=FALSE)
abline(0, af2$rotmat[2,1]/af2$rotmat[1,1], lty=2)
abline(0, af2$rotmat[2,2]/af2$rotmat[1,2], lty=2)
```

7. Stimare i punteggi fattoriali con il metodo di Thompson e rappresentarli graficamente. 

```{r}
# thompson
punt.t <- factanal(X, factors=2, rotation="none", scores="regression") 

# plot dei punteggi fattoriali
plot(punt.t$scores,pch="")
text(punt.t$scores, labels=c(1:88))

scor[66,]
scor[81,] 
scor[2,]
scor[87,]
```




