---
output:
  pdf_document: default
  html_document: default
---

```{r startup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = T, eval=T, message=F, warning=F, error=F,comment=NA, cache=F)
```

**22 Febbraio 2019 - Analisi Esplorativa**

Cognome: $\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots$

Nome: $\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots$

Matricola: $\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots$

Tipologia d'esame: $\qquad \Box$ 12 CFU $\qquad$ $\Box$ 15 CFU 

\bigskip

\hrule

**Prova scritta - fila A**

*Si svolgano gli esercizi riportando il risultato dove indicato. Durata: 80 minuti*

\bigskip

\hrule

\bigskip

### Esercizio 1 (10 punti)

Il dataset `Cars93` presente nella libreria `MASS` descrive $93$ modelli di automobile rispetto a $27$ variabili. Le variabili di interesse per l'analisi sono $p=12$ come elencato nel seguito:

* `Weight`  peso (in libbre)
* `Width` larghezza (in pollici)
* `Length` lunghezza (in pollici)
* `EngineSize` cilindrata (in litri)
* `Horsepower` potenza 
* `RPM` giri al minuto
* `Fuel.tank.capacity` capacità di carburante
* `Passengers` numero di passeggeri
* `MPG.highway`  Miglia per gallone in autostrada
* `MPG.city` Miglia per gallone in città
* `Price` prezzo (in migliaia di dollari)
* `Wheelbase` interasse (in pollici)

Sia $X$ la matrice $93 \times 12$ corrispondente al dataset `Cars93` ridotto selezionando le variabili sopra elencate. 

a. Si calcoli $d^2_M(x_i,\bar{x})$, il quadrato della distanza di Mahalanobis di ciascuna auto (ciascuna riga della matrice $X$) dal baricentro. Si riportino i valori di $d^2_M(x_i,\bar{x})$ solo se superano il valore 21, specificando anche il nome dell'automobile a cui si fa riferimento
(informazione reperibile dalla variabile `Model` del dataset `Cars93`). 

\fbox{\parbox[b][8em][t]{1\textwidth}{
$\quad$
}}

```{r}
rm(list=ls())
library(MASS)
vars = c("Weight","Width","Length","EngineSize", "Horsepower", "RPM", "Fuel.tank.capacity", "Passengers", "MPG.highway", "MPG.city","Price", "Wheelbase")
X = Cars93[,vars]
n = nrow(X)
p = ncol(X)
row.names(X)<-Cars93[,"Model"]
xbar = matrix(colMeans(X), nrow=p, ncol=1)
S = var(X) * ((n-1)/n)
InvS = solve(S)
dM2 = apply(X,MARGIN=1, function(u) t(u-xbar) %*% InvS %*% (u - xbar) )
round(dM2[dM2 > 21],2)
```

b. Svolgere l'analisi delle componenti principali sui dati standardizzati $Z$ che si ottengono a partire da $X$. Si riportino i punteggi (*scores*) per l'automobile `Firebird` relativamente alle  componenti principali 2, 8 e 10 (arrotondati alla terza cifra decimale).

\fbox{\parbox[b][3em][t]{1\textwidth}{
$\quad$
}}

```{r}
Z = scale(X,center=T,scale=diag(S)^(1/2))
round(prcomp(Z)$x["Firebird",c(2,8,10)],3)
```

c. Applicare l'algoritmo delle $K$ medie 
(`algorithm = "Hartigan-Wong"`) per i dati standardizzati $Z$ inizializzando i $K$ centrodi utilizzando le prime $K$ osservazioni (righe $1,\ldots,K$ della matrice $Z$). Arrotondando il risultato alla seconda cifra decimale, riportare per  $K=2,3,4,5$
    - il valore dell'indice  $\mathrm{CH}(K) = \frac{B/(K-1)}{W/(n-K)}$ di Calinski and Harabasz 
    - il valore medio della *silhouette* considerando come matrice delle distanze quella ottenuta con la metrica di Lagrange basata su $Z$
    
\fbox{\parbox[b][6em][t]{1\textwidth}{
$K \qquad\qquad\qquad\qquad\qquad\qquad 2 \qquad\qquad 3 \qquad\qquad 4 \qquad\qquad 5 $\\
\\
$CH(K)$\\
\\
$\mathrm{silhouette}(K)$
}}

```{r}
D = dist(Z, method="maximum")
K = 2:5
CH <- vector()
sil <- vector()
library(cluster)
for (k in 1:length(K)){
km = kmeans(Z, centers=Z[1:K[k],])
CH[k] = (km$betweenss/(K[k]-1))/(km$tot.withinss/(n-K[k]))
sil[k] = summary(silhouette(x=km$cluster, dist=D))$avg.width
}
round(rbind(K,CH,sil),2)
``` 

d. Si consideri la stima di massima verosimiglianza per il  modello fattoriale con $k$ fattori basato sui dati standardizzati $Z$. Riportare il $p$-value del primo test non significativo al livello $5\%$ (e il corrispondente valore di $k$) per la sequenza di ipotesi nulle $H_0(k=1),H_{0}(k=2),H_{0}(k=3),\ldots$ dove $H_0(k)$="il modello fattoriale con k fattori è corretto". 

\fbox{\parbox[b][3em][t]{1\textwidth}{
$\quad$
}}

```{r}
k = which.max(sapply(1:6, function(k) factanal(Z,factors=k)$PVAL > 0.05 ))
k
round(factanal(Z,factors=k)$PVAL,4)
```

e. Stimare il modello fattoriale con $k=2$ fattori con il metodo della massima verosimiglianza utilizzando i dati standardizzati $Z$ e senza effettuare alcuna rotazione. Riportare il valore della statistica test  rapporto di verosimiglianza 
$T= n \log \left(\frac{|\hat{\Lambda} \hat{\Lambda}' + \hat{\Psi}|}{|R|}\right)$ (arrotondando al terzo decimale)

\fbox{\parbox[b][3em][t]{1\textwidth}{
$\quad$
}}

```{r}
R = cor(X)
af = factanal(Z,factors=2, rotation="none", method="mle")
Lambda = af$loadings[,]
Psi = diag(af$uniqueness)
fit = Lambda %*% t(Lambda) + Psi
lrt = n*log(det(fit)/det(R))
round(lrt,3)
```


### Esercizio 2 (punti 2)

Dimostrare, esplicitando tutti i passaggi, e specificando tutte le quantità coinvolte.

Se esiste un $\underset{p\times 1}{c}\neq 0$ tale che  $\underset{p\times p}{S} \underset{p\times 1}{c} = \underset{p\times 1}{0}$, allora le colonne di $\underset{n\times p}{\tilde{X}}$ sono linearmente dipendenti.

\fbox{\parbox[b][12em][t]{1\textwidth}{ 
$\qquad$
}}

### Esercizio 3 (3 punti)

Si consideri la seguente matrice di correlazione $\underset{3\times 3}{R} = 
\left[
\begin{array}{ccc}
1 & 1/2 & 1/2 \\
1/2 & 1 & 2/3 \\
1/2 & 2/3 & 1 \\
\end{array}\right]$. 

a. Sia $\underset{n\times 3}{\tilde{X}}$ la matrice dei dati centrati. Determinare l'angolo (espresso in gradi) tra $\underset{n\times 1}{\tilde{x}_1}$ e $\underset{n\times 1}{\tilde{x}_3}$: $=\ldots\ldots\ldots\ldots$

b. Sapendo che $s_{11}=4$, $s_{22}=9$ e $\mathrm{tr}(S)=14$, calcolare  la matrice di varianze/covarianze $S$ e $S^{1/2}$ (arrotondando al secondo decimale)

$S = 
\left[
\begin{array}{ccc}
\\
\ldots\ldots &  \ldots\ldots  &  \ldots\ldots \\
\\
\ldots\ldots &  \ldots\ldots  &  \ldots\ldots\\
\\
\ldots\ldots &  \ldots\ldots  &  \ldots\ldots\\
\end{array}\right]\qquad S^{1/2} = 
\left[
\begin{array}{ccc}
\\
\ldots\ldots &  \ldots\ldots  &  \ldots\ldots \\
\\
\ldots\ldots &  \ldots\ldots  &  \ldots\ldots\\
\\
\ldots\ldots &  \ldots\ldots  &  \ldots\ldots\\
\end{array}\right]$.



```{r}
R = matrix(c(1,1/2,1/2,1/2,1,2/3,1/2,2/3,1), byrow=T, ncol=3)
# a
acos(R[1,3])*(180/pi)
# b
s11=4
s22=9
s33=14-s11-s22
D = diag(c(s11,s22,s33))
S = D^(1/2) %*% R %*% D^(1/2)
S
lambdas = eigen(S)$values
V = eigen(S)$vectors
sqrtS = V %*% diag( lambdas^(1/2) ) %*% t(V)
round(sqrtS,2)
```

\bigskip

**Esercizio 4 (2 punti)**

Si considereri la seguente matrice di correlazione calcolata sulla base di $n=50$ osservazioni:

\begin{table}[ht]
\centering
\begin{tabular}{rrrrr}
  \hline
 & $a$ & $b$ & $c$ & $d$ \\ 
  \hline
$a$  & 1 & 0.8 & 0.1 & 0.6 \\ 
$b$ & 0.8 & 1 & 0.3 & 0.7 \\ 
$c$ & 0.1 & 0.3 & 1 & 0.4 \\ 
$d$ & 0.6 & 0.7 & 0.4 & 1 \\ 
   \hline
\end{tabular}
\end{table}

Sulla base dalla matrice di correlazione, si stimi il modello fattoriale con $k=1$ fattori utilizzando il metodo della massima verosimiglianza senza effettuare alcuna rotazione.  Si determini il punteggio fattoriale con il metodo di Thompson (arrotondando alla quarta cifra decimale) per una certa unità statistica sapendo che i suoi valori standardizzati nelle quattro variabili $a$, $b$, $c$ e $d$ sono

\begin{table}[ht]
\centering
\begin{tabular}{rrrrr}
& $a$ & $b$ & $c$ & $d$\\
unità & 1.2426 & 0.7828 & -0.5209 & -0.0034 \\
\end{tabular}
\end{table}


```{r}
rm(list=ls())
X = USArrests
names(X) = c("a","b","c","d")
R = round(cor(X), 1)
hatLambda = matrix(factanal(covmat=R, factors=1, n.obs=50, rotation ="none")$ loadings[,], ncol=1)
z = c(1.2426, 0.7828, -0.5209, -0.0034)
Rinv = solve(R)
round( t(hatLambda) %*% Rinv %*% z, 4)
```

\fbox{\parbox[b][3em][t]{1\textwidth}{

\bigskip

$\hat{f}=$

}}


### Esercizio 5 (3 punti)

Alla matrice $\underset{p\times p}{S}$ sono associati i seguenti autovalori
$\lambda_1 = 6, \lambda_2 =4$
e autovettori normalizzati $\underset{2\times 1}{v_1} = \left[
\begin{array}{c}
1/\sqrt{5}\\
2/\sqrt{5}\\
\end{array}
\right]$, $\underset{2\times 1}{v_2} = \left[
\begin{array}{c}
2/\sqrt{5}\\
-1/\sqrt{5}\\
\end{array}
\right]$. 

a. Calcolare la correlazione tra la prima colonna $\underset{n\times 1}{\tilde{x}_1}$ di $\underset{n\times p}{\tilde{X}}$ e i punteggi $\underset{n\times 1}{y_1}$ della prima componente principale, arrotondando al secondo decimale 
$$= \ldots\ldots\ldots$$


b. Determinare (arrotondando al secondo decimale) la matrice di correlazione 

$\underset{p\times p}{R} = 
\left[
\begin{array}{c}
\\
\\
\\
\\
\end{array}\right.$


```{r}
rm(list=ls())
# a.
Lambda = diag(c(6,4))
V = matrix(c(1/sqrt(5),2/sqrt(5),2/sqrt(5),-1/sqrt(5)), byrow=F, ncol=2)
S = V %*% Lambda %*% t(V) 
round( V[1,1]*sqrt(Lambda[1,1])/sqrt(S[1,1]) , 2)
# b. 
R = diag(diag(S)^(-1/2)) %*% S %*% diag(diag(S)^(-1/2))
round(R,2)
```

\newpage

## Esercizio 6 (6 punti)

Dimostrare, esplicitando tutti i passaggi, e specificando tutte le quantità coinvolte.

a. Nel modello fattoriale a $k$ fattori, $\mathbb{E}(\underset{p\times 1}{x} \underset{1\times k}{f'}) = \underset{p\times k}{\Lambda}$.

b. Una generica matrice di varianze/covarianze $S$ è semidefinita positiva.

c. $\mathrm{det}(S^Y) = \mathrm{det}(S)$ dove $Y=\tilde{X}V$ e le colonne di $V$ 
sono gli autovettori normalizzati di $S$

\fbox{\parbox[b][48em][t]{1\textwidth}{

$\quad$

}}
